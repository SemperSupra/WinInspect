#!/usr/bin/env bash
set -euo pipefail
cmd="${1:-}"
shift || true

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
WBAB_DIR="${ROOT}/external/WineBotAppBuilder"

usage() {
  cat <<'EOF'
wbab (WinInspect)
Usage: tools/wbab <lint|build|test|package|sign|smoke|discover|preflight> [args]

This repository is scaffolded to work with WineBotAppBuilder (WBAB).
If WBAB submodule is present (tools/WineBotAppBuilder), build/test/package
commands will run inside WBAB containers.

EOF
}

run_local_build() {
  "${ROOT}/tools/winbuild-build.sh" "$@"
}

run_local_test() {
  "${ROOT}/scripts/wbab-test.sh" "$@"
}

case "${cmd}" in
  preflight)
    "${ROOT}/scripts/preflight.sh"
    ;;
  lint)
    if [[ -d "${WBAB_DIR}" ]]; then
      echo "--- Running WBAB Containerized Lint ---"
      
      # 1. C++ Linting via WinBuild
      echo "[lint] Running C++ linting (clang-tidy)..."
      # We use --header-filter to focus on our own headers and -checks=-* to start clean, 
      # then add specific useful checks. We also skip system headers to avoid MinGW/Clang conflicts.
      export WBAB_LINT_CMD="clang-tidy core/src/*.cpp daemon/src/*.cpp --checks=-*,bugprone-*,performance-*,readability-function-size --header-filter=core/include/.* -- -target x86_64-w64-mingw32 -fms-extensions -fms-compatibility -Icore/include -Ithird_party -I/usr/x86_64-w64-mingw32/include"
      "${WBAB_DIR}/tools/wbab" lint "$@"

      # 2. Go Linting via SupraGoFlow
      echo "[lint] Running Go linting (gofmt)..."
      GOFLOW_IMAGE="ghcr.io/sempersupra/supragoflow-build:latest"
      docker run --rm \
          -v "${ROOT}/clients/portable:/v" \
          -w /v \
          "${GOFLOW_IMAGE}" \
          bash -c "gofmt -l ."
    else
      # Fallback to local
      "${ROOT}/scripts/lint.sh" "$@"
    fi
    ;;
  build)
    if [[ -d "${WBAB_DIR}" ]]; then
      echo "--- Running WBAB Containerized Build ---"
      
      # Handle optional project dir as first arg
      PROJECT_DIR="."
      VERSION="dev"
      if [[ $# -gt 0 ]]; then
        if [[ -d "$1" ]]; then
          PROJECT_DIR="$1"
          shift
        fi
      fi
      if [[ $# -gt 0 ]]; then
        VERSION="$1"
        shift
      fi

      # Delegate to WBAB container build
      export WBAB_BUILD_CMD="/workspace/tools/ci-build.sh"
      "${WBAB_DIR}/tools/wbab" build "${PROJECT_DIR}"

      # Post-process artifacts (copy from out/ to dist/)
      DIST_DIR="${ROOT}/dist"
      mkdir -p "${DIST_DIR}"

      echo "--- Post-processing Artifacts (Version: ${VERSION}) ---"
      # ... (rest of the copy logic)
      # wbab-build/ci-build puts them in out/
      # We need to mimic tools/winbuild-build.sh naming:
      cp "${ROOT}/out/wininspectd.exe" "${DIST_DIR}/wininspectd-${VERSION}-win-x64.exe" 2>/dev/null || true
      cp "${ROOT}/out/wininspect.exe" "${DIST_DIR}/wininspect-${VERSION}-win-x64.exe" 2>/dev/null || true
      cp "${ROOT}/out/wininspect-gui.exe" "${DIST_DIR}/wininspect-gui-${VERSION}-win-x64.exe" 2>/dev/null || true

      # Run Go build via SupraGoFlow
      echo "--- Building Portable CLI (Go) via SupraGoFlow ---"
      GOFLOW_IMAGE="ghcr.io/sempersupra/supragoflow-build:latest"
      
      if [ -d "${ROOT}/clients/portable" ]; then
          # Linux Build
          echo "[build] Building Portable CLI (Linux x64)..."
          docker run --rm \
              -v "${ROOT}/clients/portable:/v" \
              -v "${DIST_DIR}:/dist" \
              -w /v \
              -e GOOS=linux \
              -e GOARCH=amd64 \
              "${GOFLOW_IMAGE}" \
              bash -c "go build -o /dist/wi-portable-${VERSION}-linux-x64"
          
          # Windows Build
          echo "[build] Building Portable CLI (Windows x64)..."
          docker run --rm \
              -v "${ROOT}/clients/portable:/v" \
              -v "${DIST_DIR}:/dist" \
              -w /v \
              -e GOOS=windows \
              -e GOARCH=amd64 \
              "${GOFLOW_IMAGE}" \
              bash -c "go build -o /dist/wi-portable-${VERSION}-win-x64.exe"
      fi
    else
      echo "WBAB submodule not found. Running local build..."
      run_local_build "$@"
    fi
    ;;
  test)
    if [[ -d "${WBAB_DIR}" ]]; then
      echo "--- Running WBAB Containerized Core Tests ---"
      # core tests (logic only) run in build container
      export WBAB_TEST_CMD="ctest --test-dir /workspace/build -C Release -E test_discovery --output-on-failure"
      "${WBAB_DIR}/tools/wbab" test "$@"
      
      echo "--- Running WineBot Environment Integration Tests ---"
      # Integration tests (networking/UIA) run in the real WineBot container via smoke.sh
      ./scripts/smoke.sh
    else
      run_local_test "$@"
    fi
    ;;
  package)
    if [[ -d "${WBAB_DIR}" ]]; then
       echo "--- Running WBAB Containerized Packaging ---"
       
       # Handle optional project dir as first arg
       PROJECT_DIR="."
       VERSION="dev"
       if [[ $# -gt 0 ]]; then
         if [[ -d "$1" ]]; then
           PROJECT_DIR="$1"
           shift
         fi
       fi
       if [[ $# -gt 0 ]]; then
         VERSION="$1"
         shift
       fi

       # Delegate to WBAB container package
       # We run makensis directly inside the packager container.
       # The .nsi script is in tools/, so BUILD_SRC relative to tools/ is ../out
       export WBAB_PACKAGE_CMD="makensis -DVERSION=${VERSION} -DBUILD_SRC=../out tools/wininspect.nsi"
       "${WBAB_DIR}/tools/wbab" package "${PROJECT_DIR}"
    else
       "${ROOT}/tools/package-nsis.sh" "$@"
    fi
    ;;
  sign)
    "${ROOT}/tools/sign-dev.sh" "$@"
    ;;
  smoke)
    "${ROOT}/scripts/smoke.sh" "$@"
    ;;
  discover)
    "${ROOT}/scripts/discover.sh" "$@"
    ;;
  e2e)
    echo "WARNING: 'e2e' is deprecated. Use 'smoke' instead."
    "${ROOT}/scripts/smoke.sh" "$@"
    ;;
  *)
    usage
    exit 2
    ;;
esac
