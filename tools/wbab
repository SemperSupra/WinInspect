#!/usr/bin/env bash
set -euo pipefail
cmd="${1:-}"
shift || true

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
WBAB_DIR="${ROOT}/tools/WineBotAppBuilder"

usage() {
  cat <<'EOF'
wbab (WinInspect)
Usage: tools/wbab <lint|build|test|package|sign|smoke|discover|preflight> [args]

This repository is scaffolded to work with WineBotAppBuilder (WBAB).
If WBAB submodule is present (tools/WineBotAppBuilder), build/test/package
commands will run inside WBAB containers.

EOF
}

run_local_build() {
  "${ROOT}/tools/winbuild-build.sh" "$@"
}

run_local_test() {
  "${ROOT}/scripts/wbab-test.sh" "$@"
}

case "${cmd}" in
  preflight)
    "${ROOT}/scripts/preflight.sh"
    ;;
  lint)
    if [[ -d "${WBAB_DIR}" ]]; then
      echo "--- Running WBAB Containerized Lint ---"
      export WBAB_LINT_CMD="/workspace/scripts/lint.sh"
      "${WBAB_DIR}/tools/wbab" lint "$@"
    else
      # Fallback to local
      "${ROOT}/scripts/lint.sh" "$@"
    fi
    ;;
  build)
    if [[ -d "${WBAB_DIR}" ]]; then
      echo "--- Running WBAB Containerized Build ---"
      # Delegate to WBAB container build
      export WBAB_BUILD_CMD="/workspace/tools/ci-build.sh"
      "${WBAB_DIR}/tools/wbab" build "$@"

      # Post-process artifacts (copy from out/ to dist/)
      VERSION="${1:-dev}"
      DIST_DIR="${ROOT}/dist"
      mkdir -p "${DIST_DIR}"

      echo "--- Post-processing Artifacts ---"
      # wbab-build/ci-build puts them in out/
      # We need to mimic tools/winbuild-build.sh naming:
      cp "${ROOT}/out/wininspectd.exe" "${DIST_DIR}/wininspectd-${VERSION}-win-x64.exe" 2>/dev/null || true
      cp "${ROOT}/out/wininspect.exe" "${DIST_DIR}/wininspect-${VERSION}-win-x64.exe" 2>/dev/null || true
      cp "${ROOT}/out/wininspect-gui.exe" "${DIST_DIR}/wininspect-gui-${VERSION}-win-x64.exe" 2>/dev/null || true

      # Run Go build via SupraGoFlow
      echo "--- Building Portable CLI (Go) via SupraGoFlow ---"
      GOFLOW_IMAGE="ghcr.io/sempersupra/supragoflow-build:latest"
      # docker pull already done or will be done by docker run
      
      if [ -d "${ROOT}/clients/portable" ]; then
          # Linux Build
          docker run --rm \
              -v "${ROOT}/clients/portable:/v" \
              -v "${DIST_DIR}:/dist" \
              -w /v \
              -e GOOS=linux \
              -e GOARCH=amd64 \
              "${GOFLOW_IMAGE}" \
              bash -c "go build -o /dist/wi-portable-${VERSION}-linux-x64"
          
          # Windows Build
          docker run --rm \
              -v "${ROOT}/clients/portable:/v" \
              -v "${DIST_DIR}:/dist" \
              -w /v \
              -e GOOS=windows \
              -e GOARCH=amd64 \
              "${GOFLOW_IMAGE}" \
              bash -c "go build -o /dist/wi-portable-${VERSION}-win-x64.exe"
      fi
    else
      echo "WBAB submodule not found. Running local build..."
      run_local_build "$@"
    fi
    ;;
  test)
    if [[ -d "${WBAB_DIR}" ]]; then
      echo "--- Running WBAB Containerized Test ---"
      # Delegate to WBAB container test
      # We use ctest on the build directory which is persisted in workspace
      export WBAB_TEST_CMD="ctest --test-dir /workspace/build -C Release --output-on-failure"
      "${WBAB_DIR}/tools/wbab" test "$@"
    else
      run_local_test "$@"
    fi
    ;;
  package)
    if [[ -d "${WBAB_DIR}" ]]; then
       echo "--- Running WBAB Containerized Packaging ---"
       # Delegate to WBAB container package
       VERSION="${1:-dev}"
       # We run makensis directly inside the packager container.
       # The .nsi script is in tools/, so BUILD_SRC relative to tools/ is ../out
       export WBAB_PACKAGE_CMD="makensis -DVERSION=${VERSION} -DBUILD_SRC=../out tools/wininspect.nsi"
       "${WBAB_DIR}/tools/wbab" package "$@"
    else
       "${ROOT}/tools/package-nsis.sh" "$@"
    fi
    ;;
  sign)
    "${ROOT}/tools/sign-dev.sh" "$@"
    ;;
  smoke)
    "${ROOT}/scripts/smoke.sh" "$@"
    ;;
  discover)
    "${ROOT}/scripts/discover.sh" "$@"
    ;;
  e2e)
    echo "WARNING: 'e2e' is deprecated. Use 'smoke' instead."
    "${ROOT}/scripts/smoke.sh" "$@"
    ;;
  *)
    usage
    exit 2
    ;;
esac
