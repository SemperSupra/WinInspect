#!/usr/bin/env bash

# Submodule Co-Evolution Policy Guardrail
# Blocks pushing to upstream remotes.

remote="$1"
url="$2"

# 1. Block by remote name ONLY if inside a submodule
# We detect this by checking if we are in the superproject root
ROOT_DIR=$(git rev-parse --show-toplevel)
if [[ "$(pwd)" != "$ROOT_DIR" ]]; then
    if [[ "$remote" == "origin" || "$remote" == "upstream" ]]; then
        echo "ERROR: Pushing from a submodule is blocked by Submodule Co-Evolution Policy." >&2
        echo "Please use scripts/submodules/export-issue-package.sh from the project root." >&2
        exit 1
    fi
fi

# 2. Block by URL pattern (Upstream Submodule Repos)
UPSTREAM_PATTERNS=(
    "SemperSupra/WineBotAppBuilder"
    "SemperSupra/supragoflow"
    "mark-e-deyoung/WineBot"
)

for pattern in "${UPSTREAM_PATTERNS[@]}"; do
    if [[ "$url" == *"$pattern"* ]]; then
        echo "ERROR: Pushing to upstream repository '$pattern' is blocked." >&2
        echo "URL: $url" >&2
        exit 1
    fi
done

exit 0
